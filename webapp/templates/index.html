<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpDesk</title>
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      align-items: center;
    }

    #header {
      background-color: #1e1e1e;
      padding: 15px 20px;
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      border-bottom: 1px solid #333;
      width: 100%;
    }

    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1000px;
      box-sizing: border-box;
    }

    #chat-container::-webkit-scrollbar {
        width: 8px;
      }
  
    #chat-container::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
      }
  
    #chat-container::-webkit-scrollbar-track {
        background-color: #1e1e1e;
    }

    .message {
      margin: 10px 0;
      padding: 14px;
      border-radius: 8px;
      max-width: 70%;
      display: inline-block;
      word-wrap: break-word;
      font-size: 18px;
      line-height: 1.6;
      overflow-wrap: break-word;
    }

    .user {
      background-color: #1e88e5;
      align-self: flex-end;
    }

    .bot {
      background-color: #424242;
      align-self: flex-start;
    }

    .message img,
    .message div[id^="plot-"],
    .message iframe {
      max-width: 100%;
      height: auto;
      display: block;
    }

    #input-container {
      display: flex;
      align-items: flex-end;
      padding: 10px;
      border-top: 1px solid #333;
      background-color: #1a1a1a;
      width: 100%;
      max-width: 1000px;
      box-sizing: border-box;
    }

    #user-input {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 20px;
      font-size: 18px;
      outline: none;
      background-color: #2a2a2a;
      color: white;
      resize: none;
      overflow-y: auto;
      min-height: 48px;
      max-height: 200px;
      line-height: 1.4em;
      box-sizing: border-box;
    }

    #user-input:disabled {
      background-color: #1e1e1e;
    }

    #send-btn {
      margin-left: 10px;
      padding: 12px 24px;
      font-size: 18px;
      background-color: #1e88e5;
      border: none;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      align-self: flex-start;
      height: 48px;
      transition: background-color 0.2s ease;
    }

    #send-btn:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    .loading {
      font-style: italic;
      opacity: 0.6;
    }

    #char-count {
      font-size: 12px;
      color: #aaa;
      text-align: right;
      width: 100%;
      max-width: 1000px;
      padding: 0 20px 5px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="header">OpDesk</div>
  <div id="chat-container"></div>
  <div id="char-count">0 / 500</div>
  <div id="input-container">
    <textarea id="user-input" placeholder="Type your message..." rows="1" maxlength="500"></textarea>
    <button id="send-btn">Send</button>
  </div>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const charCount = document.getElementById('char-count');

    let isWaitingForResponse = false;

    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 200) + 'px';
    }

    userInput.addEventListener('input', () => {
      autoResizeTextarea(userInput);
      charCount.textContent = `${userInput.value.length} / 500`;
    });

    function appendMessage(content, sender, isHTML = false) {
      const msg = document.createElement('div');
      msg.className = `message ${sender}`;
      if (isHTML) {
        msg.innerHTML = content;
      } else {
        msg.textContent = content;
      }
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function appendLoading() {
      const msg = document.createElement('div');
      msg.className = 'message bot loading';
      msg.id = 'loading-msg';
      msg.textContent = 'Thinking...';
      chatContainer.appendChild(msg);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeLoading() {
      const loadingMsg = document.getElementById('loading-msg');
      if (loadingMsg) loadingMsg.remove();
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text || isWaitingForResponse) return;

      isWaitingForResponse = true;
      appendMessage(text, 'user');
      userInput.value = '';
      autoResizeTextarea(userInput);
      charCount.textContent = '0 / 500';
      userInput.disabled = true;
      sendBtn.disabled = true;

      appendLoading();

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });

        const data = await response.json();
        removeLoading();

        if (data.type === 'text') {
          appendMessage(data.content, 'bot');
        } else if (data.type === 'image') {
          const html = `<img src="${data.content}" style="max-width:100%">`;
          appendMessage(html, 'bot', true);
        } else if (data.type === 'plot') {
          const plotDiv = document.createElement('div');
          plotDiv.className = 'message bot';
          const plotId = 'plot-' + Date.now();
          plotDiv.id = plotId;
          chatContainer.appendChild(plotDiv);
          Plotly.newPlot(plotId, data.data, data.layout);
        } else if (data.type === 'mixed') {
          let html = '';
          if (data.text) html += `<p>${data.text}</p>`;
          if (data.image) html += `<img src="${data.image}" style="max-width:100%">`;
          if (data.plot) {
            const plotId = 'plot-' + Date.now();
            html += `<div id="${plotId}" style="width:100%"></div>`;
            appendMessage(html, 'bot', true);
            Plotly.newPlot(plotId, data.plot.data, data.plot.layout);
            return;
          }
          appendMessage(html, 'bot', true);
        } else {
          appendMessage('[Error: unknown response type]', 'bot');
        }
      } catch (err) {
        console.error('Error handling response:', err);
        removeLoading();
        appendMessage('[Error: could not understand response]', 'bot');
      } finally {
        isWaitingForResponse = false;
        userInput.disabled = false;
        sendBtn.disabled = false;
        userInput.focus();
        userInput.dispatchEvent(new Event('input'));
      }
    }

    sendBtn.addEventListener('click', sendMessage);

    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
